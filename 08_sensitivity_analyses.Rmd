---
title: "08_sensitivity_analyses"
output: html_document
date: '2022-06-02'
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Library
```{r}
library(dplyr)
library(formr)
library(ggplot2)
library(psych)
library(MatchIt)
library(rbounds)
library(EValue)
```

```{r}
# Matching must be run again
# Load data
data_main = read.csv(file = "data/data_main.csv")[,-1]
```

## PSM for partner preferences
### Check for missings in covariates to be matched
psm cannot handle missings
covariates: language, age, country, relationship status, relationship length
```{r}
# MatchIt does not allow missing values
data_main_nomiss <- data_main %>% dplyr::select(id, language, age, sex, country, relationship_status, relationship_length, sexual_orientation,
                                         pref_imp_ks, pref_imp_att, pref_imp_fs, pref_imp_ca,
                                         pref_imp_ei, pref_imp_sexually_experienced) %>%
                                  na.omit()

table(is.na(data_main_nomiss)) # no more NAs in data set
```

### Check if correct variable type 
```{r}
typeof(data_main_nomiss$sexual_orientation) # is variable of type character, but for PSM it needs to be a factor
data_main_nomiss$sexual_orientation = as.factor(data_main_nomiss$sexual_orientation) # convert to factor
levels(data_main_nomiss$sexual_orientation) # check levels of factor
data_main_nomiss$sexual_orientation = factor(data_main_nomiss$sexual_orientation,
                                             levels=rev(levels(data_main_nomiss$sexual_orientation))) # reverse order of factor levels 
levels(data_main_nomiss$sexual_orientation) # check factor level order
```

### Matching with nearest-neighbor-algortihm without caliper
```{r}
nnm <- matchit(sexual_orientation ~ language + age + country + relationship_status + relationship_length, method = "nearest", data = data_main_nomiss)

nnm_data <- match.data(nnm)
```

## Sensitivity Analyses
### Rosenbaum's sensitivity analysis
For each outcome separately (only outcomes with significant results)
## partner preferences
#### confident-assertive
```{r}
# rbounds package evaluates match Object from Matching package, since I have used the MatchIt package for matching, I must extract the values for the outcomes for each matching pair 
m.pairs.pref_imp_ca <- cbind(nnm_data[row.names(nnm$match.matrix), 'pref_imp_ca'],
nnm_data[nnm$match.matrix, 'pref_imp_ca'])

x = m.pairs.pref_imp_ca[,1] # asexuals
y = m.pairs.pref_imp_ca[,2] # heterosexuals


psens(x = y, y = x, Gamma = 6, GammaInc = 0.1)

####
nnm
nnm$match.matrix
nnm$treat
row.names(nnm$match.matrix)
```
Gamma = 2.6 --> p-Value becomes significant. 


```{r}
data = nnm_data %>% 
        group_by(sexual_orientation) %>%
        arrange(subclass, .by_group = TRUE)


x = data %>% dplyr::filter(sexual_orientation == "Asexual") %>% dplyr::select(pref_imp_ca)
x = x[,2]

y = data %>% dplyr::filter(sexual_orientation == "Straight/Heterosexual") %>% dplyr::select(pref_imp_ca)
y = y[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
psens(x = y, y = x, Gamma = 6, GammaInc = 0.1)


```


#### attractive
```{r}
# extracting outcome for both group in same order
m.pairs.pref_imp_att <- cbind(nnm_data[row.names(nnm$match.matrix), 'pref_imp_att'],
nnm_data[nnm$match.matrix, 'pref_imp_att'])

x = m.pairs.pref_imp_att[,1]
y = m.pairs.pref_imp_att[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 3.1 --> p-Value becomes significant.

#### sexually experienced
```{r}
# extracting outcome for both group in same order
m.pairs.pref_imp_sexually_experienced <- cbind(nnm_data[row.names(nnm$match.matrix), 'pref_imp_sexually_experienced'],
nnm_data[nnm$match.matrix, 'pref_imp_sexually_experienced'])

x = m.pairs.pref_imp_sexually_experienced[,1]
y = m.pairs.pref_imp_sexually_experienced[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 1.7 --> p-Value becomes significant.


### kind-supportive
```{r}
# extracting outcome for both group in same order
m.pairs.pref_imp_ks<- cbind(nnm_data[row.names(nnm$match.matrix), 'pref_imp_ks'],
nnm_data[nnm$match.matrix, 'pref_imp_ks'])

x = m.pairs.pref_imp_ks[,1]
y = m.pairs.pref_imp_ks[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 4.7 --> p-Value becomes significant.

### financially secure - successful
```{r}
# extracting outcome for both group in same order
m.pairs.pref_imp_fs <- cbind(nnm_data[row.names(nnm$match.matrix), 'pref_imp_fs'],
nnm_data[nnm$match.matrix, 'pref_imp_fs'])

x = m.pairs.pref_imp_fs[,1]
y = m.pairs.pref_imp_fs[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 1.9 --> p-Value becomes significant.

## Self-ratings
## PSM for self-ratings
### Check for missings in covariates to be matched
psm cannot handle missings
covariates: language, age, country, relationship status, relationship length
```{r}
# MatchIt does not allow missing values
data_main_nomiss_self <- data_main %>% dplyr::select(id, language, age, sex, country, relationship_status, relationship_length, sexual_orientation,
                                         self_ks, self_att, self_fs,self_ca, self_ei, self_sexually_experienced) %>%
                                  na.omit()

table(is.na(data_main_nomiss_self)) # no more NAs in data set
```

### Check if correct variable type 
```{r}
typeof(data_main_nomiss_self$sexual_orientation) # is variable of type character, but for PSM it needs to be a factor
data_main_nomiss_self$sexual_orientation = as.factor(data_main_nomiss_self$sexual_orientation) # convert to factor
levels(data_main_nomiss_self$sexual_orientation) # check levels of factor
data_main_nomiss_self$sexual_orientation = factor(data_main_nomiss_self$sexual_orientation,
                                             levels=rev(levels(data_main_nomiss_self$sexual_orientation))) # reverse order of factor levels
levels(data_main_nomiss_self$sexual_orientation) # check factor level order
```

### Matching
#### Matching with nearest-neighbor-algortihm without caliper
```{r}
nnm_self <- matchit(sexual_orientation ~ language + age + country + relationship_status + relationship_length, method = "nearest", data = data_main_nomiss_self)

nnm_self_data <- match.data(nnm_self)
```
No asexual unmatched. 


### confident-assertive
```{r}
#  extracting outcome for both group in same order
m.pairs.self_ca <- cbind(nnm_self_data[row.names(nnm_self$match.matrix), 'self_ca'],
nnm_self_data[nnm_self$match.matrix, 'self_ca'])

x = m.pairs.self_ca[,1]
y = m.pairs.self_ca[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 2.8 --> p-Value becomes significant.

### attractive
```{r}
#  extracting outcome for both group in same order
m.pairs.self_att <- cbind(nnm_self_data[row.names(nnm_self$match.matrix), 'self_att'],
nnm_self_data[nnm_self$match.matrix, 'self_att'])

x = m.pairs.self_att[,1]
y = m.pairs.self_att[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 3.2 --> p-Value becomes significant.

### sexually experienced
```{r}
#  extracting outcome for both group in same order
m.pairs.self_sexually_experienced <- cbind(nnm_self_data[row.names(nnm_self$match.matrix), 'self_sexually_experienced'],
nnm_self_data[nnm_self$match.matrix, 'self_sexually_experienced'])

x = m.pairs.self_sexually_experienced[,1]
y = m.pairs.self_sexually_experienced[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1) # at Gamma = 6 still no change in p-value
psens(x = x, y = y, Gamma = 10, GammaInc = 0.1)
```
Gamma = 6.5 --> p-Value becomes significant.

### kind-supportive
```{r}
#  extracting outcome for both group in same order
m.pairs.self_ks <- cbind(nnm_self_data[row.names(nnm_self$match.matrix), 'self_ks'],
nnm_self_data[nnm_self$match.matrix, 'self_ks'])

x = m.pairs.self_ks[,1]
y = m.pairs.self_ks[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 2.6 --> p-Value becomes significant.

### financially secure-successful
```{r}
#  extracting outcome for both group in same order
m.pairs.self_fs <- cbind(nnm_self_data[row.names(nnm_self$match.matrix), 'self_fs'],
nnm_self_data[nnm_self$match.matrix, 'self_fs'])

x = m.pairs.self_fs[,1]
y = m.pairs.self_fs[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 2.9 --> p-Value becomes significant.

### educated-intelligent
```{r}
#  extracting outcome for both group in same order
m.pairs.self_ei <- cbind(nnm_self_data[row.names(nnm_self$match.matrix), 'self_ei'],
nnm_self_data[nnm_self$match.matrix, 'self_ei'])

x = m.pairs.self_ei[,1]
y = m.pairs.self_ei[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 1.8 --> p-Value becomes significant.

## PSM for relationship options
### Check for missings in covariates to be matched
psm cannot handle missings
covariates: language, age, country, relationship status, relationship length
```{r}
# MatchIt does not allow missing values
data_main_nomiss_rel <- data_main %>% dplyr::select(id, language, age, sex, country, relationship_status, relationship_length,
                                             sexual_orientation,
                                             interest_hookups,
                                             interest_nonsexrel,
                                             interest_monrel,
                                             interest_monrel,
                                             interest_nonmonrel,
                                             interest_altrel,
                                             interest_single,
                                             interest_parent) %>%
                                      na.omit()

table(is.na(data_main_nomiss_rel)) # no more NAs in data set
```

### Check if correct variable type 
```{r}
typeof(data_main_nomiss_rel$sexual_orientation) # is variable of type character, but for PSM it needs to be a factor
data_main_nomiss_rel$sexual_orientation = as.factor(data_main_nomiss_rel$sexual_orientation) # convert to factor
levels(data_main_nomiss_rel$sexual_orientation) # check levels of factor
data_main_nomiss_rel$sexual_orientation = factor(data_main_nomiss_rel$sexual_orientation,
                                             levels=rev(levels(data_main_nomiss_rel$sexual_orientation))) # reverse order of factor levels
levels(data_main_nomiss_rel$sexual_orientation) # check factor level order
```

#### Matching with nearest-neighbor-algortihm without caliper
```{r}
nnm_rel <- matchit(sexual_orientation ~ language + age + country + relationship_status + relationship_length, method = "nearest", data = data_main_nomiss_rel)

nnm_rel_data <- match.data(nnm_rel)
```

### interest non-sexual relationships
```{r}
#  extracting outcome for both group in same order
m.pairs.interest_nonsexrel <- cbind(nnm_rel_data[row.names(nnm_rel$match.matrix), 'interest_nonsexrel'],
nnm_rel_data[nnm_rel$match.matrix, 'interest_nonsexrel'])

x = m.pairs.interest_nonsexrel[,1]
y = m.pairs.interest_nonsexrel[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
??????

### interest sexual relationships
```{r}
#  extracting outcome for both group in same order
m.pairs.interest_hookups <- cbind(nnm_rel_data[row.names(nnm_rel$match.matrix), 'interest_hookups'],
nnm_rel_data[nnm_rel$match.matrix, 'interest_hookups'])

x = m.pairs.interest_hookups[,1]
y = m.pairs.interest_hookups[,2]

psens(x = y, y = x, Gamma = 6, GammaInc = 0.1)
?psens
```
Gamma = 5.9

### interest monogamous relationships
```{r}
#  extracting outcome for both group in same order
m.pairs.interest_monrel <- cbind(nnm_rel_data[row.names(nnm_rel$match.matrix), 'interest_monrel'],
nnm_rel_data[nnm_rel$match.matrix, 'interest_monrel'])

x = m.pairs.interest_monrel[,1]
y = m.pairs.interest_monrel[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
Gamma = 3.6

### interest non-monogamous relationships
```{r}
#  extracting outcome for both group in same order
m.pairs.interest_nonmonrel <- cbind(nnm_rel_data[row.names(nnm_rel$match.matrix), 'interest_nonmonrel'],
nnm_rel_data[nnm_rel$match.matrix, 'interest_nonmonrel'])

x = m.pairs.interest_nonmonrel[,1]
y = m.pairs.interest_nonmonrel[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
?????


### interest alternative committed relationships
```{r}
#  extracting outcome for both group in same order
m.pairs.interest_altrel <- cbind(nnm_rel_data[row.names(nnm_rel$match.matrix), 'interest_altrel'],
nnm_rel_data[nnm_rel$match.matrix, 'interest_altrel'])

x = m.pairs.interest_altrel[,1]
y = m.pairs.interest_altrel[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
?????

### interest single
```{r}
#  extracting outcome for both group in same order
m.pairs.interest_single <- cbind(nnm_rel_data[row.names(nnm_rel$match.matrix), 'interest_single'],
nnm_rel_data[nnm_rel$match.matrix, 'interest_single'])

x = m.pairs.interest_single[,1]
y = m.pairs.interest_single[,2]

psens(x = x, y = y, Gamma = 6, GammaInc = 0.1)
```
????

### interest parent
```{r}
#  extracting outcome for both group in same order
m.pairs.interest_parent <- cbind(nnm_rel_data[row.names(nnm_rel$match.matrix), 'interest_parent'],
nnm_rel_data[nnm_rel$match.matrix, 'interest_parent'])

x = m.pairs.interest_parent[,1]
y = m.pairs.interest_parent[,2]

psens(x = y, y = x, Gamma = 6, GammaInc = 0.1)
```
Gamma = 5.7

### E-Value
### partner preferencs
#### confident-assertive
```{r}
evalue(MD(0.40), lo = 0.51, hi = 0.24)
?evalue
-0.51, -0.24
```

